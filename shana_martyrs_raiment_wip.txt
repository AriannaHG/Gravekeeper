[ItemType]  name=Martyr's Raiment;
ID=shana_martyrs_raiment; sprite=3; texture=qpart;
description=Dauntless robe that defies mortal wounds. <n=>Damage recieved in excess of 20% of the wearer's maximum <icon=hp> will be deferred until the end of the wearer's turn.; 
journalID=shana_journal_martyrs_raiment;
weight=1; volume=3; value=9999;
itemCategory=3; 
pB=pGreyD2;
pR=pScur2;
[ItemEffect]
ID=shana_martyrs_raiment; actorValue=skill_Life; magnitude=2; duration=-1;
[ItemEffect]
ID=shana_martyrs_raiment; actorValue=PhysEva; magnitude=10; duration=-1;
[ItemReaction]
ID=shana_martyrs_raiment;
actorValues=HP; action=shana_martyrs_raiment_act; aiRatingMod=2; -----------TODO: try set to d:shana_martyrs_raiment_damage_prevented 
[JournalEntry]
ID=shana_journal_martyrs_raiment;
category=equipment; halfPage=true; rarity=4;
title=Martyr's Raiment;
text=<itemBig=shana_martyrs_raiment><title=Martyr's Raiment><brAdj=>An unassuming robe of mundane origin, once donned by a frail old woman who used her failing, plague-ridden body to buy time for the citizens of Barrow to flee the undead hordes. Any instance of damage exceeding 20% of the wearer's maximum <icon=HP> has the excess damage converted to a delayed wound, borne in full at the end of the wearer's turn. Predictably, the raiment's power does not work on debt accrued in this way.;

--------------------------------------------------------Martyrs Raiment Formulas --change dmg healed for low hp case
[FormulaGlobal] ID=shana_0.2_maxhp;
formula=c:HPMax * 0.2;

[FormulaGlobal] ID=shana_floor_0.2_maxhp;
formula=floor:d:shana_0.2_maxhp;

[FormulaGlobal] ID=shana_martyrs_raiment_threshold;
formula=min:1:d:shana_floor_0.2_maxhp;

--[FormulaGlobal] ID=shana_current_hp_minus_threshold; -- due to order of operations I need to add back last damage taken as I want hp before being hit
--formula=c:HP - d:shana_martyrs_raiment_threshold;

--[FormulaGlobal] ID=shana_is_hp_above_threshold;
--formula=moreThan:0:d:shana_current_hp_minus_threshold;

[FormulaGlobal] ID=shana_martyrs_raiment_damage_prevented;
formula=m:cLastDmgTaken - d:shana_martyrs_raiment_threshold;

[FormulaGlobal] ID=shana_martyrs_raiment_did_it_proc;
formula=moreThan:0:d:shana_martyrs_raiment_damage_prevented - c:negate; --prevent negate still giving debuff

--[FormulaGlobal] ID=shana_martyrs_raiment_healback; --pseud
--formula=min(d:shana_martyrs_raiment_damage_prevented, c:HP-d:shana_martyrs_raiment_threshold


--------------------------------------------------------Action for Martyr's Raiment, only occurring when hp dmg taken more than 20% wearers max hp rounded down.
[Action] ID=shana_martyrs_raiment_act; 
harmful=false;
special=usableEvenWhenCantAct;
special=usableEvenWhenReacting;
special=usableEvenWhenYourTurn;
[ActionAoE] 
    ID=shana_martyrs_raiment_act;
    cloneFrom=oneTile;
[AvAffecter] --------------------------------------------------------------------------------------------give redeemed suffering TODO: Make this not work if the damage type is shana_redeemedSuffering. 
    ID=shana_martyrs_raiment_act; 
    harmful=false;
    actorValue=shana_redeemed_suffering_status; 
    magnitude=d:shana_martyrs_raiment_damage_prevented + t:shana_redeemed_suffering_status;
    duration=9999; --TODO and ask
    chance=m:cLastDmgTakenGreaterThanX(0) * 100 + d:shana_martyrs_raiment_did_it_proc * 100 - 100; --procs only if took damage, not heal, hp is actually above threshold
    FXOnHit=hitDust_shatterNegate;
    FXOnHit=square16_shine_big;
    visibleMiss=false;
[AvAffecterAoE]
    ID=shana_martyrs_raiment_act;
    cloneFrom=oneTile;
[AvAffecter] ---------------------------------------------------------------------------------------------this will actually prevent damage by instantly healing that much back.
ID=shana_martyrs_raiment_act; 
    harmful=false;
    actorValue=HPTrue;
    magnitude=d:shana_martyrs_raiment_damage_prevented;
    duration=-2;
    chance=m:cLastDmgTakenGreaterThanX(0) * 100 + d:shana_martyrs_raiment_did_it_proc * 100 - 100;
    visibleEvaluations=false;
    visibleMiss=false;
[AvAffecterAoE]
    ID=shana_martyrs_raiment_act;
    cloneFrom=oneTile;

----------------------------------------------------------------Redeemed Suffering Status AV
[ActorValue]
ID=shana_redeemed_suffering_status;
name=Redeemed Suffering;
icon=<icon=icon_gravekeeper_rot>;
bubbleIcon=icon_rot;
minimum=0;
maximum=999;
removedByNegativeMagnitude=true;
--description=;
defaultValue = 0; AIValue = 1;
harmfulMagnitude = 1;
--bonusesMultiplier = 1;
animationOnHarmful = pain;
affectsActors = true;
canAffectIncapped = false;
showDamageNumbers = true;
showDamageNumbersMagnitude = true;
showDamageNumbersSign = false;
showDamageNumbersIcon = true;
showDamageNumbersElements = true;
showDamageNumbersIconInTooltips = true;
damageNumberColor_Positive = Green;
damageNumberColor_Negative = Green;
actorPaletteOverride =;
actorPaletteOverrideDuration = 0.27;
elementReactionModifiesDuration = false;
canBeRemovedByNonspecificAVEffectRemoval = true;
recordInActorData = true;
showEvaluationInfo = true;
allowDecimalValues = false;
percentage = false;
XPCostBase = 0;
XPCostIncrement = 0;
XPCostMultiplier = 1;
XPCostFloorToNearest = 0;

[ActorValueReaction]
ID=shana_redeemed_suffering_status; actorValues=shana_redeemed_suffering_status; newID=shana_redeemed_suffering_status;

[ActorValueReaction]
ID=shana_redeemed_suffering_status; element=ruinTouch; damageMultiplier=1.34;

--Deal damage at the end of an actor's turn and remove itself - TODO


